// With build can plugin v1.15+, you can easily add expensive data inside the background {} block. Everything inside
// here is executed in a separate thread, and guaranteed to complete before finishing the build and publishing the
// scan.
buildScan.background {
    // Tracking whether a build is 'dirty' (that is, has uncommitted changes) can be useful when diagnosing
    // failures. It's simple to capture values from git.
    // `execAndGetStdout` is a custom method defined below.
    def status = execAndGetStdout('git', 'status', '--porcelain')

    if (status != null && !status.isEmpty()) {
        tag 'dirty'
        value 'Git status', status
    }
}

// This method can be used for executing arbitrary shell processes
def execAndGetStdout(String... args) {
    def stdout = new ByteArrayOutputStream()
    exec {
        commandLine(args)
        standardOutput = stdout
    }
    return stdout.toString().trim()
}
