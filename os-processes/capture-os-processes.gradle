/**
 * This Gradle script captures OS processes as reported by the OS 'ps' command, as custom value.
 */

addStringMethods()

buildScan.background {
    def psOutput = execAndGetStdout('ps', '-o pid,ppid,time,command')
    buildScan.value 'OS processes', psOutput
}

static String execAndGetStdout(String... args) {
    def exec = args.toList().execute()
    exec.waitFor()
    exec.text.trimAtEnd()
}

static void addStringMethods() {
    if (!String.metaClass.respondsTo('', 'trimAtEnd')) {
        String.metaClass.trimAtEnd = {
            ('x' + delegate).trim().substring(1)
        }
    }
}
